# todo

- サーバ wait の実装
  - wait 完了条件
    - 入力タスクが終了&受信リクエストが空、送信タスクが終了

OutgoingBuffer がデータ追加を必要に応じて無視するようにする

- セッション初期化メインループ
  - 入力終了時処理
    - [ ] 全ての現存する outgoingRequest をエラーにする（値が既に設定されたものを除く）
    - [ ] 将来的な outgoingRequest をエラーにする
    - [ ] レスポンスの送信が完了したらサーバ待機タスクを正常終了する
      - レスポンス送信完了はどうやって判断するか？
        - 送信タスクが完了
          - 送信タスクは、incomingRequest が 0 かつ、入力タスクが終了していると終了する
  - IO エラー処理
    - 入力 IO エラー
      - 入力終了時処理と同等の処理に加え、サーバ待機タスクをエラーで終了する
    - 出力 IO エラー
      - 未送信のリクエストを全てエラーにし、加えて、将来的なリクエストを全てエラーにする
      - サーバ待機タスクをエラーで終了する
  - サーバ終了時にはメインタスクを abort させる
- シャットダウン
  - 入力終了時処理と同等
- Error の実装を隠す
- キャンセル対応
- notify のエラーをロギング
- 自実装同士の通信
- 他実装との通信
- 通知処理の graceful shutdown
- バッチ処理対応
- 読み込みインターフェイスの効率化（入力のバッファ効率化(RawValue を利用)）
- SSE に対応できるように書き込みインターフェイスを変更する

- outgoingRequest のエラー種別

  - Shutdown
  - WriterError
  - ReaderError
  - ReaderEnd

- 二種類のシャットダウン　 Shutdown と abort

  - Shutdown
    - [ ] 入力タスクを強制終了する
    - [ ] 各メソッドハンドラをキャンセルする
    - [ ] メソッドハンドラのキャンセル完了を待機する
    - [ ] キャンセル完了とデータ送信が完了したら、サーバ待機タスクを正常終了する
      - メソッドハンドラをキャンセルするのならデータ送信も必要ないのでは？
  - Abort
    - [ ] 入力、出力、ハンドラを強制終了し、待機しない
    - [ ] Session 破棄により、これを行う。主にクライアントで使用

- write task
  - バッファからデータを取得し、書き込む
  - バッファ取得 Future が必要

## 処理手順

- 2 つのタスクを生成
  - メッセージ読み込みとディスパッチタスク
    - エラーはどう扱う？
      - IO エラー以外は、メッセージとして書き込み
      - IO エラーは、リクエスト、notify,sessionawait 時にエラーを返す
  - メッセージ書き込みタスク
    - エラーはどう扱う
      - リクエスト、notify,sessionawait 時にエラーを返す
- 実装の必要があるのは・・・
  - エラーの転送システム
    - IO エラーを保存し、全 OutgoingRequest と Session await に転送する
  - 二つのタスク生成
  - Reader 終了検知
    - Reader が終了すると、全 OutgoingRequest を終了エラーにする
    - あとはどうする？
      - 全ハンドラの終了を待機
      - シャットダウン
  - Session await
    - Reader が終了するか、IO
      がエラーを発生するか、シャットダウンリクエストが行われるかした後、全ハンドラが終了すると終了する
    - その際、IO エラーがあれば返す
  - シャットダウンリクエスト
    - 全 OutgoingRequest を中断する
    - ReaderTask を中断する
    - WriterTask を中断する
  - シャットダウン開始という処理があっても良いかも
    - 新タスクはキャンセルしないが、新規タスクの実行は禁止し、現タスクの終了を待つ

## 解決済み

- poll していない incomingRequest が消えないのはどうする？
  - poll は outgoingRequest に関係あり、incomingRequest には関係ない。outgoingRequest は消えなくても問題なさそう
