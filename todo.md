# todo

- 処理を一通り実装
  - キャンセル対応
  - シャットダウン
  - notify のエラーをロギング
  - IO エラー処理
  - クライアント用、通知とリクエストの API
  - セッション初期化メインループ
  - 自実装同士の通信
  - 他実装との通信
  - Error の実装を隠す
  - 通知処理の graceful shutdown

## 処理手順

- 2 つのタスクを生成
  - メッセージ読み込みとディスパッチタスク
    - エラーはどう扱う？
      - IO エラー以外は、メッセージとして書き込み
      - IO エラーは、リクエスト、notify,sessionawait 時にエラーを返す
  - メッセージ書き込みタスク
    - エラーはどう扱う
      - リクエスト、notify,sessionawait 時にエラーを返す
- 実装の必要があるのは・・・
  - エラーの転送システム
    - IO エラーを保存し、全 OutgoingRequest と Session await に転送する
  - 二つのタスク生成
  - Reader 終了検知
    - Reader が終了すると、全 OutgoingRequest を終了エラーにする
    - あとはどうする？
      - 全ハンドラの終了を待機
      - シャットダウン
  - Session await
    - Reader が終了するか、IO がエラーを発生するか、シャットダウンリクエストが行われるかした後、全ハンドラが終了すると終了する
    - その際、IO エラーがあれば返す
  - シャットダウンリクエスト
    - 全 OutgoingRequest を中断する
    - ReaderTask を中断する
    - WriterTask を中断する
  - シャットダウン開始という処理があっても良いかも
    - 新タスクはキャンセルしないが、新規タスクの実行は禁止し、現タスクの終了を待つ
